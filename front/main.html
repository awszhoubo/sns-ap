<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>AIローカライズ投稿支援システム</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
    }
    header {
      # background-color: #333;
      background: linear-gradient(120deg, #74ebd5, #acb6e5);
      color: #00f;
      padding: 1rem;
      text-align: center;
      font-size: 1.2rem;
      margin: 0.2rem 1.2rem 0.2rem 1.2rem;
      border-radius: 8px;
    }
    .maincontainer {
      # background: #FFCCCC;
      background: white;
      padding: 0;
      margin: 0.2rem 1.2rem 0.2rem 1.2rem;
      border-radius: 0px;
      display: flex;
      height: calc(100vh - 60px);
    }

    .sidebar {
      width: 240px;
      background-color: #99CCFF;
      # background: #FFCCCC;
      # border-right: 1px solid #ccc;
      white-space: nowrap;
      # margin: 1.2rem 1.2rem 1.2rem 1.2rem;
      border-radius: 12px 12px 12px 12px;
    }
    .sidebar button {
      display: block;
      width: 90%;
      padding: 1rem;
      border: none;
      background: none;
      text-align: left;
      cursor: pointer;
      font-size: 0.9rem;
      color: #212529;
      border-radius: 12px 12px 12px 12px;
      margin: 5px 10px 5px 10px;
    }
    .sidebar button:hover {
      # background-color: #ddd;
      background-color: #FFE5CC;
    }
    .sidebar button.active {
      # background-color: #bbb;
      background-color: white;
      # font-weight: bold;
    }
    .maincontent {
      # background: blue;
      flex: 1;
      padding: 0rem;
      overflow-y: auto;
      margin: 0px 0px 0px 10px;
      border-radius: 12px 12px 12px 12px;
    }

    .modal {
      position: fixed;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal-content {
      background: #fff;
      width: 400px;
      margin: 10% auto;
      padding: 20px;
      border-radius: 6px;
    }

    .form-item {
      margin-bottom: 12px;
    }

    .form-item label {
      display: block;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .modal-actions {
      text-align: right;
    }
  </style>
</head>
<body>
  <header>
    <div style="display: flex; justify-content: space-between; align-items: center; color: white; padding: 1rem;">
      <div>
        <h1 style="margin:0;">AIローカライズ投稿支援システム</h1>
      </div>
      <div>
        <span id="welcomeText"></span>
        <a href="#" id="signOut" style="
          color: white;
          text-decoration: none;
          background-color: #e53935;
          padding: 0.4rem 0.8rem;
          border-radius: 4px;
          font-size: 0.9rem;
          margin: 2rem;
        ">Sign Out</a>

      </div>
    </div>
  </header>
  <div class="maincontainer">
    <!-- 左侧菜单 -->
    <nav class="sidebar">
      <button onclick="loadPage('page2.html', this)" class="active">申し込み情報管理</button>
      <button onclick="loadPage('page3.html', this)">日本投稿元情報(X)</button>
      <button onclick="loadPage('page4.html', this)">日本投稿元情報(Instagram)</button>
      <button onclick="loadPage('page5.html', this)">中国投稿先情報(Weibo)</button>
      <button onclick="loadPage('page6.html', this)">中国投稿先情報(Xiaohongshu)</button>
      <button onclick="loadPage('page57.html', this)">手動投稿(Weibo)</button>
      <button onclick="loadPage('page68.html', this)">手動投稿(Xiaohongshu)</button>
      <button onclick="loadPage('page9.html', this)">レポート</button>
      <button onclick="loadPage('manual.html', this)">マニュアル</button>
      <button id="adminOnlyBtn" style="display: none;" onclick="loadPage('page1.html', this)">ユーザー一覧(管理者向け)</button>
    </nav>

    <!-- 右侧内容 -->
    <main id="maincontent" class="maincontent">
      <!-- 默认加载内容 -->
      <h2>Loading...</h2>
    </main>
  </div>

  <script>
    const pageMap = new Map([
      ["page2.html", 0],
      ["page3.html", 1],
      ["page4.html", 2],
      ["page5.html", 3],
      ["page6.html", 4],
      ["page57.html", 5],
      ["page68.html", 6],
      ["page9.html", 7],
      ["manual.html", 8],
      ["page1.html", 9],
    ]);

    function onJapanSnsChange(radio) {
      const japanSnsUrl = document.getElementById("japanSnsUrl");
      const chinaRadios = document.getElementsByName("chinaSnsName");
      const chinaSnsUrl = document.getElementById("chinaSnsUrl");

      if (radio.value === "x") {
        japanSnsUrl.placeholder = "https://x.com/nm_nanaparty";
        japanSnsUrl.title = "https://x.com/nm_nanaparty";
        chinaSnsUrl.placeholder = "https://weibo.com/6623739479";
        chinaSnsUrl.title = "https://weibo.com/6623739479";
        chinaRadios.forEach(r => {
          r.checked = (r.value === "weibo");
        });
      } else if (radio.value === "instagram") {
        japanSnsUrl.placeholder = "https://www.instagram.com/awszhoubo2025/";
        japanSnsUrl.title = "https://www.instagram.com/awszhoubo2025/";
        chinaSnsUrl.placeholder = "https://www.xiaohongshu.com/user/profile/6589e5fd000000002200149a";
        chinaSnsUrl.title = "https://www.xiaohongshu.com/user/profile/6589e5fd000000002200149a";
        chinaRadios.forEach(r => {
          r.checked = (r.value === "xiaohongshu");
        });
      }
    }

    async function manualPostXiaohongshu() {
      const postContentZH = document.getElementById("postContentZH").value.trim();
      if (postContentZH == "") {
        alert("中国語に翻訳してください。");
        return;
      }
      const payload = { postContentZH }
      try {
        const response = await fetch('https://api.sns-ap.com/weibo/manual', {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          },
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.statusCode == '200') {
          alert(data.post_result);
        } else {
          alert(data.post_result || '不明なエラー');
        }
      } catch (err) {
        alert('リクエストに失敗しました: ' + err.message);
      }
    }

    async function manualPostWeibo() {
      const postContentZH = document.getElementById("postContentZH").value.trim();
      if (postContentZH == "") {
        alert("中国語に翻訳してください。");
        return;
      }
      const payload = { postContentZH }
      try {
        const response = await fetch('https://api.sns-ap.com/weibo/manual', {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          },
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.statusCode == '200') {
          alert(data.post_result);
        } else {
          alert(data.post_result || '不明なエラー');
        }
      } catch (err) {
        alert('リクエストに失敗しました: ' + err.message);
      }
    }

    async function weiboLogin(username) {
      try {
        // const username = localStorage.getItem("userName")
        const res = await fetch(`https://api.sns-ap.com/weibo/oauth-url?username=${encodeURIComponent(username)}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "X-Client-Referer": window.location.href,
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          throw new Error('无法获取授权链接');
        }

        const data = await res.json();
        const authUrl = data.auth_url;
        if (authUrl) {
          window.location.href = authUrl;
        } else {
          alert("获取授权链接失败");
        }
      } catch (err) {
        console.error("无法获取授权链接", err);
        alert("发生错误，无法绑定微博");
      }
    }

    // function weiboLogin() {
      // 打开微博 OAuth 登录页面
    //  window.open("weibo_login.html", "_blank");
    // }

    async function fetchXiaohongshuUsers() {
      try {
        const res = await fetch("https://api.sns-ap.com/xiaohongshu/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const container = document.getElementById("userList");
        const data = await res.json();

        data.forEach(user => {
          const card = document.createElement("div");
          card.className = "user-card";

          card.innerHTML = `
            <a href="${user.china_sns_url}"><img class="user-photo" src="${user.i_photo}" /></a>
            <div class="user-name">${user.customer_name}(xiaohongshu)</div>
            <div class="user-link">
              <a href="xiaohongshu_posts.html?userId=${user.xiaohongshu_uid}&userName=${user.customer_name}&userPhoto=${encodeURIComponent(user.i_photo)}" target="_blank" class="view-link">投稿を見る</a>
            </div>
          `;

          container.appendChild(card);
        });
      } catch (error) {
        alert(error)
        console.error("Error fetching users:", error);
        document.getElementById("userList").innerHTML = "<p>Failed to load user list.</p>";
      }
    }

    async function fetchXiaohongshuUsers68() {
      try {
        const res = await fetch("https://api.sns-ap.com/xiaohongshu/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const container = document.getElementById("userList");
        const data = await res.json();

        data.forEach(user => {
          const card = document.createElement("div");
          card.className = "user-card";

          card.innerHTML = `
            <a href="${user.china_sns_url}"><img class="user-photo" src="${user.i_photo}" /></a>
            <div class="user-name">${user.customer_name}(xiaohongshu)</div>
            <div class="user-link">
              <a href="page8.html?userId=${user.xiaohongshu_uid}&userName=${user.customer_name}&userPhoto=${encodeURIComponent(user.i_photo)}" target="_blank" class="view-link">手動投稿</a>
            </div>
          `;

          container.appendChild(card);
        });
      } catch (error) {
        alert(error)
        console.error("Error fetching users:", error);
        document.getElementById("userList").innerHTML = "<p>Failed to load user list.</p>";
      }
    }

    async function initWeiboUserList() {
      try {
        const userSelect = document.getElementById("weiboUserSelect");
        const res = await fetch("https://api.sns-ap.com/weibo/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const data = await res.json();

        data.forEach(user => {
          const o = document.createElement("option");
          o.value = user.weibo_uid;
          o.text = user.customer_name;
          userSelect.append(o);
        });
        userSelect.onchange = () => fetchWeiboStats(userSelect.value);
        if (userSelect.options.length) fetchWeiboStats(userSelect.value);
      } catch (error) {
        document.getElementById("userList").innerHTML = "<p>Failed to load weibo user list！</p>";
      }
    }

    async function fetchWeiboUsers() {
      try {
        const res = await fetch("https://api.sns-ap.com/weibo/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const container = document.getElementById("userList");
        const data = await res.json();

        data.forEach(user => {
          const card = document.createElement("div");
          card.className = "user-card";

          card.innerHTML = `
            <a href="${user.china_sns_url}"><img class="user-photo" src="${user.x_photo}" /></a>
            <div class="user-name">${user.customer_name}(weibo)</div>
            <div class="user-link">
              <a href="weibo_posts.html?userId=${user.weibo_uid}&userName=${user.customer_name}&userPhoto=${user.x_photo}" target="_blank" class="view-link">投稿を見る</a>
            </div>
          `;

          container.appendChild(card);
        });
      } catch (error) {
        alert(error)
        console.error("Error fetching users:", error);
        document.getElementById("userList").innerHTML = "<p>Failed to load user list.</p>";
      }
    }

    async function fetchWeiboUsers57() {
      try {
        const res = await fetch("https://api.sns-ap.com/weibo/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const container = document.getElementById("userList");
        const data = await res.json();

        data.forEach(user => {
          const card = document.createElement("div");
          card.className = "user-card";

          card.innerHTML = `
            <a href="${user.china_sns_url}"><img class="user-photo" src="${user.x_photo}" /></a>
            <div class="user-name">${user.customer_name}(weibo)</div>
            <div class="user-link">
              <a href="page7.html?userId=${user.weibo_uid}&userName=${user.customer_name}&userPhoto=${user.x_photo}" target="_blank" class="view-link">手動投稿</a>
            </div>
          `;

          container.appendChild(card);
        });
      } catch (error) {
        alert(error)
        console.error("Error fetching users:", error);
        document.getElementById("userList").innerHTML = "<p>Failed to load user list.</p>";
      }
    }

    async function fetchAccounts() {
      try {
        const response = await fetch("https://api.sns-ap.com/x/register/account", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (response.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const users = await response.json();

        const container = document.getElementById("accounts-container");
        container.innerHTML = ""; // 清空容器

        users.forEach(user => {
          const card = document.createElement("div");
          card.className = "user-card";
          const autoPost = user.auto_post === "yes" ? "利用する" : "利用しない"
          const manualPost = user.manual_post === "yes" ? "on" : "off"
          const forbidKeyword = user.forbid_keyword;
          // const jobState = user.job_state === "DISABLED" ? "無効" : "有効"
          // const jobStateComment = user.weibo_bind === "no" ? " (Weiboと連携していないため、自動投稿できません。)" : ""
          // const wbLinkShowFlag = user.job_state === "DISABLED" ? "visible" : "none"
          const wbLinkShowFlag = user.weibo_bind === "no" ? "block" : "none"
          const wbBindFlag = user.weibo_bind === "yes" ? "block" : "none"
          const userPhoto = user.japan_sns_name === "x" ? user.x_photo : user.i_photo
          // const chinaSnsUid = user.japan_sns_name === "x" ? user.weibo_uid : user.xiaohongshu_uid
          const chinaSnsUid = user.weibo_uid !== "" ? user.weibo_uid : user.xiaohongshu_uid
          // const chinaSnsDisplayName = user.japan_sns_name === "x" ? "Weibo" : "RED"
          const chinaSnsDisplayName = user.weibo_uid !== "" ? "Weibo" : "RED"
          const japanSnsDisplayName = user.japan_sns_name === "x" ? "X" : "Instagram"
          const chinaSnsLogo = user.japan_sns_name === "x" ? "weibo_logo.png" : "xiaohongshu_logo.png"

          card.innerHTML = `
            <img class="user-photo" src="${userPhoto}" alt="${user.customer_name}">
            <div class="user-info">
              <div><strong>${user.customer_name}</strong></div><br />
              <div>${japanSnsDisplayName} ID: ${user.customer_id}</div>
              <div>${chinaSnsDisplayName} ID: ${chinaSnsUid}</div>
              <div>
                日本SNS: <a href="${user.japan_sns_url}" target="_blank">${user.japan_sns_name}</a>
              </div>
              <div>
                中国SNS: <a href="${user.china_sns_url}" target="_blank">${user.china_sns_name}</a>
              </div>
              <div>炎上防止キーワード: ${forbidKeyword}</div>
              <div style="display: none;">自動投稿機能: ${autoPost}</div>
              <div>手動投稿機能: ${manualPost}</div>
              <div>決済方法: ${user.payment_method}</div>
              <div style="display: ${wbLinkShowFlag};">
                <p style="color:red">${chinaSnsDisplayName}と連携していないため、自動投稿できません。</p>
                <button class="weibo-login-btn" onclick="weiboLogin(${chinaSnsUid})">
                  <img src="photo/${chinaSnsLogo}" alt="Weibo Logo" width="24" height="24">
                  ${chinaSnsDisplayName}ログインして連携する
                </button>
              </div>
              <div style="display: ${wbBindFlag};">
                ✅ ${chinaSnsDisplayName}アカウントに連携済！
              </div>
              <button style="background-color: #4a90e2; color: white; border-radius: 6px; margin-top: 15px; max-width: 150px; padding: 10px" onclick='openEditModal(${JSON.stringify(user)})'>
                申し込み情報編集
              </button>
            </div>

            <!-- 编辑账号 Modal -->
            <div id="editModal" class="modal" style="display:none;">
              <div class="modal-content">
                <h3>申し込み情報編集</h3>


                <input type="hidden" id="edit-customer-name-hidden">

                <!--
                <div class="form-item">
                  <strong>■ 顧客名:</strong>
                  <span id="edit-customer-name-label"></span>
                </div>
                <br />
                -->

                <div class="form-item">
                  ■ 顧客名:
                  <input type="text" id="edit-customer-name">
                </div>

                <div class="form-item">
                  ■ 日本SNS:
                  <input type="text" id="edit-japan-sns" style="width: 200px;">
                </div>

                <div class="form-item">
                  ■ 中国SNS:
                  <input type="text" id="edit-china-sns" style="width: 200px;">
                </div>

                <div class="form-item">
                  ■ 炎上防止キーワード:
                  <input type="text" id="edit-forbid-keyword">
                </div>

                <div class="form-item" style="display:none;">
                  ■ 自動投稿機能:
                  <select id="edit-auto-post">
                    <option value="yes">利用する</option>
                    <option value="no">利用しない</option>
                  </select>
                </div>

                <div class="form-item">
                  ■ 手動投稿機能:
                  <select id="edit-manual-post">
                    <option value="yes">on</option>
                    <option value="no">off</option>
                  </select>
                </div>

                <div class="form-item">
                  ■ 決済方法:
                  <select id="edit-payment-method">
                    <option value="クレジットカード">クレジットカード</option>
                    <option value="PayPay">PayPay</option>
                    <option value="コンビニ決済">コンビニ決済</option>
                    <option value="請求書（郵送）払い">請求書（郵送）払い</option>
                  </select>
                </div>

                <div class="modal-actions">
                  <button onclick="saveEdit()">保存</button>
                  <button onclick="closeEditModal()">キャンセル</button>
                </div>
              </div>
            </div>

          `;
          container.appendChild(card);
        });

      } catch (error) {
        console.error("Error fetching users:", error);
      }
    }

    async function fetchInstagramUsers() {
      try {
        const res = await fetch("https://api.sns-ap.com/i/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const container = document.getElementById("userList");
        const data = await res.json();

        data.forEach(user => {
          const card = document.createElement("div");
          card.className = "user-card";

          card.innerHTML = `
            <a href="${user.japan_sns_url}"><img class="user-photo" src="${user.i_photo}" /></a>
            <div class="user-name">${user.customer_name}(Instagram)</div>
            <div class="user-link">
              <a href="instagram_posts.html?userId=${user.customer_id}&userName=${user.i_display_name}&userPhoto=${encodeURIComponent(user.i_photo)}" target="_blank" class="view-link">投稿を見る</a>
            </div>
          `;

          container.appendChild(card);
        });
      } catch (error) {
        alert(error)
        console.error("Error fetching users:", error);
        document.getElementById("userList").innerHTML = "<p>Failed to load user list.</p>";
      }
    }

    async function fetchAdminUsers() {
      try {
        const res = await fetch("https://api.sns-ap.com/admin/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const data = await res.json();

        const tbody = document.querySelector('#userTable tbody');
        tbody.innerHTML = '';

        data.forEach(user => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.user_name || ''}</td>
            <td>${user.person_name || ''}</td>
            <td>${user.email_address || ''}</td>
            <td>${user.company_name || ''}</td>
          `;
          tbody.appendChild(tr);
        });

        document.getElementById('userTable').style.display = 'table';
      } catch (error) {
        alert(error)
        console.error("Error fetching users:", error);
        document.getElementById("loading").innerHTML = "<p>Failed to load user list.</p>";
      }
    }

    async function fetchUsers() {
      try {
        const res = await fetch("https://api.sns-ap.com/x/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const container = document.getElementById("userList");
        const data = await res.json();

        data.forEach(user => {
          const card = document.createElement("div");
          card.className = "user-card";

          card.innerHTML = `
            <a href="${user.japan_sns_url}"><img class="user-photo" src="${user.x_photo}" /></a>
            <div class="user-name">${user.customer_name}(X)</div>
            <div class="user-link">
              <a href="posts.html?userId=${user.customer_id}&userName=${user.x_display_name}&userPhoto=${user.x_photo}" target="_blank" class="view-link">投稿を見る</a>
            </div>
          `;

          container.appendChild(card);
        });
      } catch (error) {
        alert(error)
        console.error("Error fetching users:", error);
        document.getElementById("userList").innerHTML = "<p>Failed to load user list.</p>";
      }
    }

    let postChart = null;

    async function fetchWeiboStats(userId) {
      try {
        const res = await fetch(`https://api.sns-ap.com/weibo/users/${userId}/stat`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          alert(res.status);
          localStorage.removeItem("authToken");
          window.location.href = "login.html";
          return;
        }

        const data = await res.json();

        const labels = Object.keys(data);
        const values = Object.values(data);

        const ctx = document.getElementById('postChart').getContext('2d');
        if (postChart) {
          postChart.destroy();
        }

        postChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Post数',
              data: values,
              fill: false,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Post Date'
                }
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Post Count'
                }
              }
            }
          }
        });
      } catch (error) {
        alert(error)
        console.error("Error fetching stats:", error);
        document.getElementById("errMsg").innerHTML = "<p>Failed to load stats.</p>";
      }
    }

    function initPage(url) {
      if (url == 'page3.html') {
        fetchUsers();
      } else if (url == 'page4.html') {
        fetchInstagramUsers();
      } else if (url == 'page2.html') {
        fetchAccounts();
      } else if (url == 'page5.html') {
        fetchWeiboUsers();
      } else if (url == 'page6.html') {
        fetchXiaohongshuUsers();
      } else if (url == 'page57.html') {
        // document.getElementById('bindWeiboBtn').addEventListener('click', onBindWeiboClick);
        // document.getElementById('translateBtn').addEventListener('click', translate);
        // document.getElementById('manualPostWeiboBtn').addEventListener('click', manualPostWeibo);
        // checkWeiboBind();
        fetchWeiboUsers57();
      } else if (url == 'page68.html') {
        // document.getElementById('bindXiaohongshuBtn').addEventListener('click', onBindWeiboClick);
        // document.getElementById('translateBtn').addEventListener('click', translate);
        // document.getElementById('manualPostXiaohongshuBtn').addEventListener('click', manualPostXiaohongshu);
        // checkXiaohongshuBind();
        fetchXiaohongshuUsers68();
      } else if (url == 'page9.html') {
        initWeiboUserList();
      } else if (url == 'page1.html') {
        fetchAdminUsers();
      } else {
        // Code to be executed if both condition1 and condition2 are false
      }
    }

    async function checkXiaohongshuBind() {
      const response = await fetch('https://api.sns-ap.com/xiaohongshu/bind', {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
        }
      });

      if (response.status != '200') {
        localStorage.removeItem("authToken");
        window.location.href = "login.html";
        return;
      }

      const data = await response.json();
      const xiaohongshu_uid = data.xiaohongshu_uid;
      if (xiaohongshu_uid == "") {
        document.getElementById("success-message").style.display = "none";
        document.getElementById("bind-xiaohongshu-div").style.display = "block";
        document.getElementById("manualPostXiaohongshuBtn").disabled  = true;
        document.getElementById("manualPostXiaohongshuBtn").style.background = "gray";
      } else {
        document.getElementById("xiaohongshu-uid").textContent = xiaohongshu_uid;
        document.getElementById("bind-xiaohongshu-div").style.display = "none";
        document.getElementById("success-message").style.display = "block";
        document.getElementById("manualPostXiaohongshuBtn").disabled  = false;
        document.getElementById("manualPostXiaohongshuBtn").style.background = "#007bff";
      }
    }

    async function checkWeiboBind() {
      const response = await fetch('https://api.sns-ap.com/weibo/bind', {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
        }
      });

      if (response.status != '200') {
        localStorage.removeItem("authToken");
        window.location.href = "login.html";
        return;
      }

      const data = await response.json();
      const weibo_uid = data.weibo_uid;
      if (weibo_uid == "") {
        document.getElementById("success-message").style.display = "none";
        document.getElementById("bind-weibo-div").style.display = "block";
        document.getElementById("manualPostWeiboBtn").disabled  = true;
        document.getElementById("manualPostWeiboBtn").style.background = "gray";
      } else {
        document.getElementById("weibo-uid").textContent = weibo_uid;
        document.getElementById("bind-weibo-div").style.display = "none";
        document.getElementById("success-message").style.display = "block";
        document.getElementById("manualPostWeiboBtn").disabled  = false;
        document.getElementById("manualPostWeiboBtn").style.background = "#007bff";
      }
    }

    async function translate() {
      const text = document.getElementById("postContentJA").value.trim();
      if (text == "") {
        alert("日本語で入力してだくさい。");
        return;
      }
      const response = await fetch('https://api.sns-ap.com/x/translate', {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
        },
        body: JSON.stringify({ text: text })
      });
      const data = await response.json();
      document.getElementById("postContentZH").textContent = data.translated;
    }

    function loadPage(url, btn) {
      localStorage.setItem("naviPage", url);
      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error("加载失败: " + res.status);
          return res.text();
        })
        .then(html => {
          document.getElementById('maincontent').innerHTML = html;
          initPage(url)
        })
        .catch(err => {
          document.getElementById('maincontent').innerHTML = "<p style='color:red'>" + err.message + "</p>";
        });

      // 更新菜单高亮
      document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    // 默认进入时加载 page2.html
    window.onload = () => {
      const token = localStorage.getItem("authToken");

      if (!token) {
        // No token found, redirect to login page
        localStorage.removeItem("authToken");
        window.location.href = "login.html";
        return;
      }
      const username = localStorage.getItem("userName");
      if (username === 'admin') {
        document.getElementById('adminOnlyBtn').style.display = 'inline-block';
      }
      document.getElementById("welcomeText").textContent = `ようこそ ${username}`;
      const naviPage = localStorage.getItem("naviPage");
      if (naviPage) {
        const buttonIndex = pageMap.get(naviPage)
        const naviBtn = document.querySelectorAll('.sidebar button')[buttonIndex];
        loadPage(naviPage, naviBtn);
      } else {
        loadPage('page2.html', document.querySelector('.sidebar button'));
      }
    };

    document.getElementById("signOut").addEventListener("click", function(e) {
      e.preventDefault();
      // 清除 localStorage 中的 authToken 和 userName
      localStorage.removeItem("authToken");
      localStorage.removeItem("userName");
      localStorage.removeItem("naviPage");
      window.location.href = "login.html";
    });

    async function handleAccountRegister(e) {
      const form = document.getElementById('accountRegisterForm');
      e.preventDefault();

      // 清空错误提示
      document.querySelectorAll('.error').forEach(el => el.textContent = '');

      const customerName = form.customerName.value.trim();
      const japanSnsName = form.japanSnsName.value.trim();
      const japanSnsUrl = form.japanSnsUrl.value.trim();
      const chinaSnsName = form.chinaSnsName.value.trim();
      const chinaSnsUrl = form.chinaSnsUrl.value.trim();
      const forbidKeyword = form.forbidKeyword.value.trim();
      const accountValidFlag = form.accountValidFlag.value.trim();
      const autoPost = form.autoPost.value.trim();
      const manualPost = form.manualPost.value.trim();
      const paymentMethod = form.paymentMethod.value.trim();

      let hasError = false;

      if (customerName.length < 1) {
        document.getElementById('customerNameError').textContent = '顧客名は必須です。';
        hasError = true;
      }
      if (japanSnsUrl.length < 1) {
        document.getElementById('japanSnsUrlError').textContent = '投稿情報取得URLは必須です。';
        hasError = true;
      }
      if (chinaSnsUrl.length < 1) {
        document.getElementById('chinaSnsUrlError').textContent = '投稿先アクセスURLは必須です。';
        hasError = true;
      }

      if (hasError) return;

      const payload = { customerName, japanSnsName, japanSnsUrl, chinaSnsName, chinaSnsUrl, forbidKeyword, accountValidFlag, autoPost, manualPost, paymentMethod };

      try {
        const response = await fetch('https://api.sns-ap.com/x/register/account', {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          },
          body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.statusCode == '200') {
          alert('登録に成功しました！');
          form.reset();
          loadPage('page2.html', document.querySelector('.sidebar button'));
        } else {
          alert(data.statusCode)
          alert('登録に失敗しました: ' + (data.message || '不明なエラー'));
        }
      } catch (err) {
        alert('リクエストに失敗しました: ' + err.message);
      }
    }

    async function onBindWeiboClick() {
      try {
        const username = localStorage.getItem("userName")
        const res = await fetch(`https://api.sns-ap.com/weibo/oauth-url?username=${encodeURIComponent(username)}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "X-Client-Referer": window.location.href,
            "Authorization": "Bearer " + localStorage.getItem("authToken")
          }
        });

        if (res.status != '200') {
          throw new Error('无法获取授权链接');
        }

        const data = await res.json();
        const authUrl = data.auth_url;
        if (authUrl) {
          window.location.href = authUrl;
        } else {
          alert("获取授权链接失败");
        }
      } catch (err) {
        console.error("无法获取授权链接", err);
        alert("发生错误，无法绑定微博");
      }
    }

    function openEditModal(user) {
      document.getElementById("edit-customer-name-hidden").value = user.customer_name;
      document.getElementById("edit-customer-name").value = user.customer_name;
      // document.getElementById("edit-customer-name-label").innerText =user.customer_name;
      document.getElementById("edit-japan-sns").value = user.japan_sns_url || "";
      document.getElementById("edit-china-sns").value = user.china_sns_url || "";
      document.getElementById("edit-forbid-keyword").value = user.forbid_keyword || "";
      document.getElementById("edit-auto-post").value = user.auto_post;
      document.getElementById("edit-manual-post").value = user.manual_post;
      document.getElementById("edit-payment-method").value = user.payment_method;

      document.getElementById("editModal").style.display = "block";
    }

    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
    }

    async function saveEdit() {
      const customerName = document.getElementById("edit-customer-name-hidden").value;

      if (!customerName) {
        alert("customer_name が取得できません");
        return;
      }

      const payload = {
        customer_name: customerName,
        forbid_keyword: document.getElementById("edit-forbid-keyword").value.trim(),
        auto_post: document.getElementById("edit-auto-post").value,
        manual_post: document.getElementById("edit-manual-post").value,
        payment_method: document.getElementById("edit-payment-method").value
      };

      try {
        const response = await fetch(
          `https://api.sns-ap.com/x/register/account`,
          {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + localStorage.getItem("authToken")
            },
            body: JSON.stringify(payload)
          }
        );

        if (!response.ok) {
          alert("更新失敗");
          return;
        }

        closeEditModal();
        fetchAccounts(); // 重新加载列表
      } catch (e) {
        console.error(e);
        alert("通信エラー");
      }
    }


  </script>
</body>
</html>
